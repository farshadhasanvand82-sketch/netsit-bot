# bot.py - ربات netsit.ir File Bot
import telebot
import sqlite3
import datetime
import os
import requests
import tempfile
from moviepy.editor import VideoFileClip
from telebot.types import InlineKeyboardMarkup, InlineKeyboardButton

# توکن خودت رو اینجا بذار
TOKEN = 'YOUR_BOT_TOKEN_HERE'  # عوض کن!
bot = telebot.TeleBot(8317450115:AAFNd21Z1Cy2vhO8txQA2iid8-Y6_VZyESI)

# آیدی ادمین
ADMIN_ID = 5819488865  # آیدی عددی @ihade3 رو بذار (از @userinfobot بگیر)

# دیتابیس
def init_db():
    conn = sqlite3.connect('users.db', check_same_thread=False)
    conn.execute('''
        CREATE TABLE IF NOT EXISTS users (
            user_id INTEGER PRIMARY KEY,
            username TEXT,
            daily_usage INTEGER DEFAULT 0,
            last_reset TEXT,
            subscription TEXT DEFAULT 'free',
            expiry TEXT
        )
    ''')
    conn.commit()
    conn.close()

init_db()

# چک کردن حجم روزانه
def check_daily_limit(user_id):
    conn = sqlite3.connect('users.db')
    cursor = conn.cursor()
    cursor.execute("SELECT daily_usage, last_reset, subscription FROM users WHERE user_id = ?", (user_id,))
    row = cursor.fetchone()
    
    if not row:
        conn.execute("INSERT INTO users (user_id, daily_usage, last_reset) VALUES (?, 0, ?)", 
                     (user_id, datetime.datetime.now().strftime("%Y-%m-%d")))
        conn.commit()
        conn.close()
        return True, 0
    
    usage, last_reset, sub = row
    today = datetime.datetime.now().strftime("%Y-%m-%d")
    
    if last_reset != today:
        conn.execute("UPDATE users SET daily_usage = 0, last_reset = ? WHERE user_id = ?", (today, user_id))
        conn.commit()
        conn.close()
        return True, 0
    
    conn.close()
    if sub != 'free':
        return True, usage  # پریمیوم نامحدود
    return usage < 1024, usage  # ۱ گیگ = 1024 مگابایت

# اضافه کردن حجم
def add_usage(user_id, size_mb):
    conn = sqlite3.connect('users.db')
    conn.execute("UPDATE users SET daily_usage = daily_usage + ? WHERE user_id = ?", (size_mb, user_id))
    conn.commit()
    conn.close()

# تغییر کاور ویدیو
def change_cover(video_path, cover_path, output_path):
    try:
        clip = VideoFileClip(video_path)
        cover = VideoFileClip(cover_path).subclip(0, 1)
        final = clip.set_thumbnail(cover)
        final.write_videofile(output_path, codec="libx264", audio_codec="aac")
        return True
    except:
        return False

# دانلود از اینستاگرام
def download_instagram(url):
    try:
        api_url = f"https://api.instagram.com/oembed/?url={url}"
        response = requests.get(api_url).json()
        if 'thumbnail_url' in response:
            return response['media_url'] or response['thumbnail_url']
    except:
        pass
    return None

# دستور استارت
@bot.message_handler(commands=['start'])
def start(message):
    user_id = message.from_user.id
    markup = InlineKeyboardMarkup()
    markup.add(InlineKeyboardButton("تماس با ادمین", url="https://t.me/ihade3"))
    
    bot.send_message(
        message.chat.id,
        "خوش آمدید کانال ما @net_sit\n\n"
        "فایل، لینک یا ویدیو اینستاگرام بفرستید تا براتون دانلود کنم!\n"
        "رایگان تا ۱ گیگ در روز",
        reply_markup=markup
    )

# مدیریت ادمین
@bot.message_handler(commands=['admin'])
def admin_panel(message):
    if message.from_user.id != ADMIN_ID:
        return
    bot.reply_to(message, "ادمین عزیز! دستورات:\n"
                          "/add_week @username\n"
                          "/add_month @username\n"
                          "/add_year @username\n"
                          "/remove @username\n"
                          "/stats")

# اضافه کردن اشتراک
@bot.message_handler(func=lambda m: m.text and m.text.startswith('/add_week'))
def add_week(message):
    if message.from_user.id != ADMIN_ID: return
    try:
        username = message.text.split()[1].replace('@', '')
        conn = sqlite3.connect('users.db')
        expiry = (datetime.datetime.now() + datetime.timedelta(days=7)).strftime("%Y-%m-%d")
        conn.execute("UPDATE users SET subscription = 'premium', expiry = ? WHERE username = ?", (expiry, username))
        conn.commit()
        conn.close()
        bot.reply_to(message, f"اشتراک هفتگی برای @{username} فعال شد!")
    except: bot.reply_to(message, "خطا! یوزرنیم درست وارد کن.")

# همین‌طور برای ماهانه و سالانه
@bot.message_handler(func=lambda m: m.text and m.text.startswith('/add_month'))
def add_month(message):
    if message.from_user.id != ADMIN_ID: return
    try:
        username = message.text.split()[1].replace('@', '')
        conn = sqlite3.connect('users.db')
        expiry = (datetime.datetime.now() + datetime.timedelta(days=30)).strftime("%Y-%m-%d")
        conn.execute("UPDATE users SET subscription = 'premium', expiry = ? WHERE username = ?", (expiry, username))
        conn.commit()
        conn.close()
        bot.reply_to(message, f"اشتراک ماهانه برای @{username} فعال شد!")
    except: bot.reply_to(message, "خطا!")

@bot.message_handler(func=lambda m: m.text and m.text.startswith('/add_year'))
def add_year(message):
    if message.from_user.id != ADMIN_ID: return
    try:
        username = message.text.split()[1].replace('@', '')
        conn = sqlite3.connect('users.db')
        expiry = (datetime.datetime.now() + datetime.timedelta(days=365)).strftime("%Y-%m-%d")
        conn.execute("UPDATE users SET subscription = 'premium', expiry = ? WHERE username = ?", (expiry, username))
        conn.commit()
        conn.close()
        bot.reply_to(message, f"اشتراک سالانه برای @{username} فعال شد!")
    except: bot.reply_to(message, "خطا!")

@bot.message_handler(func=lambda m: m.text and m.text.startswith('/remove'))
def remove_sub(message):
    if message.from_user.id != ADMIN_ID: return
    try:
        username = message.text.split()[1].replace('@', '')
        conn = sqlite3.connect('users.db')
        conn.execute("UPDATE users SET subscription = 'free', expiry = NULL WHERE username = ?", (username,))
        conn.commit()
        conn.close()
        bot.reply_to(message, f"اشتراک @{username} قطع شد!")
    except: bot.reply_to(message, "خطا!")

# آمار
@bot.message_handler(commands=['stats'])
def stats(message):
    if message.from_user.id != ADMIN_ID: return
    conn = sqlite3.connect('users.db')
    cursor = conn.cursor()
    cursor.execute("SELECT COUNT(*) FROM users")
    total = cursor.fetchone()[0]
    cursor.execute("SELECT COUNT(*) FROM users WHERE subscription = 'premium'")
    premium = cursor.fetchone()[0]
    conn.close()
    bot.reply_to(message, f"آمار:\nکاربران: {total}\nپریمیوم: {premium}")

# دریافت فایل
@bot.message_handler(content_types=['document', 'video'])
def handle_file(message):
    user_id = message.from_user.id
    username = message.from_user.username or "unknown"
    
    # چک حجم
    can_download, usage = check_daily_limit(user_id)
    if not can_download and message.document:
        size_mb = message.document.file_size / (1024*1024)
    elif message.video:
        size_mb = message.video.file_size / (1024*1024)
    else:
        size_mb = 0
    
    if not can_download:
        markup = InlineKeyboardMarkup()
        markup.add(InlineKeyboardButton("خرید اشتراک", url="https://t.me/ihade3"))
        bot.reply_to(message, 
                     "حجم رایگان شما (۱ گیگ) تموم شد!\n"
                     "برای خرید اشتراک به ادمین پیام بدید:", 
                     reply_markup=markup)
        return

    # دانلود فایل
    file_info = bot.get_file(message.document.file_id if message.document else message.video.file_id)
    file = bot.download_file(file_info.file_path)
    
    # ذخیره موقت
    with tempfile.NamedTemporaryFile(delete=False, suffix='.mp4') as tmp:
        tmp.write(file)
        tmp_path = tmp.name
    
    # ارسال لینک
    file_url = f"https://api.telegram.org/file/bot{TOKEN}/{file_info.file_path}"
    add_usage(user_id, size_mb)
    
    markup = InlineKeyboardMarkup()
    markup.add(InlineKeyboardButton("تغییر کاور", callback_data=f"cover_{file_info.file_id}"))
    
    bot.send_message(message.chat.id, 
                     f"فایل آماده شد!\n"
                     f"حجم: {size_mb:.1f} مگابایت\n"
                     f"لینک دانلود:\n{file_url}", 
                     reply_markup=markup)

# تغییر کاور
@bot.callback_query_handler(func=lambda call: call.data.startswith('cover_'))
def change_cover_callback(call):
    if call.from_user.id != ADMIN_ID:
        bot.answer_callback_query(call.id, "فقط ادمین می‌تونه کاور عوض کنه!")
        return
    bot.answer_callback_query(call.id, "عکس کاور بفرستید...")
    # مرحله بعدی در message handler

# ادامه در پیام بعدی.

